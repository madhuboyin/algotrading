<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Algorithmic Trading Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìà</text></svg>">
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <div class="header">
            <h1>üìà Algorithmic Trading Dashboard</h1>
            <p>Technical Analysis & Entry Point Scanner for 3-4 Month Swing Trading</p>
            <div class="header-stats">
                <span class="stat-item">
                    <strong>Target Return:</strong> 25-30%
                </span>
                <span class="stat-item">
                    <strong>Holding Period:</strong> 3-4 Months
                </span>
                <span class="stat-item">
                    <strong>Max Risk:</strong> 2% per trade
                </span>
            </div>
        </div>
        
        <!-- Instructions Section -->
        <div class="instructions">
            <h3>üìã How to Use:</h3>
            <p>Select from the 10 quick pick tickers below or enter any stock symbol to get comprehensive technical analysis with entry signals, stop loss, profit targets, and entry recommendations.</p>
        </div>
        
        <!-- Enhanced Stock Symbol Input Section -->
        <div class="symbol-input-section">
            <!-- Quick Select Tickers (Dynamic from tickers.py) -->
            <div class="quick-select-container">
                <h3>üéØ Quick Select:</h3>
                <div class="quick-symbols-row" id="quickSelectRow">
                    <!-- Tickers will be loaded dynamically from tickers.py -->
                </div>
            </div>
            
            <!-- Indicator Selection Section -->
            <div class="indicator-selection-container">
                <h3>üìä Select Technical Indicators</h3>
                <div class="indicator-toggle-header">
                    <button class="toggle-indicators-btn" onclick="toggleIndicatorSelection()">
                        <span id="indicatorToggleText">Customize Indicators</span>
                        <span id="indicatorToggleIcon">‚ñº</span>
                    </button>
                    <div class="indicator-summary">
                        <span id="selectedIndicatorCount">12</span> indicators selected
                    </div>
                </div>
                
                <div class="indicator-selection-panel" id="indicatorSelectionPanel" style="display: none;">
                    <div class="indicator-controls">
                        <button class="preset-btn" onclick="loadIndicatorPreset('default')">Default Set</button>
                        <button class="preset-btn" onclick="loadIndicatorPreset('minimal')">Minimal Set</button>
                        <button class="preset-btn" onclick="loadIndicatorPreset('advanced')">Advanced Set</button>
                        <button class="preset-btn" onclick="loadIndicatorPreset('all')">All Indicators</button>
                    </div>
                    
                    <div class="indicator-categories" id="indicatorCategories">
                        <!-- Indicator categories will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Custom Symbol Input -->
            <div class="custom-input-container">
                <h3>üíª Or Enter Any Symbol</h3>
                <div class="input-container">
                    <input type="text" id="symbolInput" placeholder="Enter symbol (e.g., AAPL, TSLA, MSFT)" maxlength="10">
                    <button id="analyzeBtn" onclick="analyzeInputSymbol()">Analyze Stock</button>
                </div>
            </div>
        </div>
        
        <!-- Loading Message -->
        <div id="loadingMessage" class="loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Analyzing technical indicators and generating complete trading plan... Please wait ‚è≥</p>
        </div>
        
        <!-- Analysis Results Container -->
        <div id="analysisResult" class="analysis-result" style="display: none;">
            <!-- Analysis results will be displayed here dynamically -->
        </div>
        
        <!-- Error Message Container -->
        <div id="errorMessage" class="error-message" style="display: none;">
            <!-- Error messages will be displayed here -->
        </div>
        
        <!-- Footer Information -->
        <div class="footer">
            <div class="disclaimer">
                <h4>‚ö†Ô∏è Risk Disclaimer:</h4>
                <p>This tool provides technical analysis for educational purposes only. Not financial advice. 
                   Always conduct your own research and consider consulting a financial advisor before making investment decisions. 
                   Trading involves risk of loss.</p>
            </div>
            <div class="footer-info">
                <p>Data provided by Yahoo Finance | Analysis updated in real-time</p>
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        // Global variables
        var currentSymbol = null;
        var quickSelectTickers = [];
        var selectedIndicators = {};
        var indicatorConfig = {};
        
        // Default indicator configuration
        const defaultIndicatorConfig = {
            'Trend Indicators': {
                'SMA_20': { name: 'Simple Moving Average (20)', description: 'Short-term trend', default: true, required: false },
                'SMA_50': { name: 'Simple Moving Average (50)', description: 'Medium-term trend', default: true, required: false },
                'SMA_100': { name: 'Simple Moving Average (100)', description: 'Long-term trend', default: true, required: false },
                'SMA_200': { name: 'Simple Moving Average (200)', description: 'Major trend', default: true, required: true },
                'EMA_20': { name: 'Exponential Moving Average (20)', description: 'Fast trend', default: true, required: false },
                'EMA_50': { name: 'Exponential Moving Average (50)', description: 'Medium trend', default: true, required: true },
                'ADX': { name: 'Average Directional Index', description: 'Trend strength', default: true, required: false }
            },
            'Momentum Indicators': {
                'RSI': { name: 'Relative Strength Index', description: 'Momentum oscillator', default: true, required: true },
                'MACD': { name: 'MACD', description: 'Trend momentum', default: true, required: true },
                'Stochastic': { name: 'Stochastic Oscillator', description: 'Momentum indicator', default: true, required: false },
                'Williams_R': { name: 'Williams %R', description: 'Momentum oscillator', default: true, required: false },
                'ROC': { name: 'Rate of Change', description: 'Price momentum', default: false, required: false },
                'CCI': { name: 'Commodity Channel Index', description: 'Momentum indicator', default: false, required: false },
                'UO': { name: 'Ultimate Oscillator', description: 'Multi-timeframe momentum', default: false, required: false },
                'TRIX': { name: 'TRIX', description: 'Triple exponential momentum', default: false, required: false }
            },
            'Volume Indicators': {
                'Volume_SMA': { name: 'Volume Moving Average', description: 'Volume trend', default: true, required: true },
                'MFI': { name: 'Money Flow Index', description: 'Volume momentum', default: true, required: false },
                'OBV': { name: 'On-Balance Volume', description: 'Volume accumulation', default: true, required: false },
                'VWAP': { name: 'Volume Weighted Average Price', description: 'Volume-weighted price', default: false, required: false }
            },
            'Volatility Indicators': {
                'BB': { name: 'Bollinger Bands', description: 'Volatility bands', default: true, required: false },
                'ATR': { name: 'Average True Range', description: 'Volatility measure', default: true, required: false },
                'PC': { name: 'Price Channels', description: 'Donchian channels', default: false, required: false }
            }
        };
        
        // Initialize indicator selection
        function initializeIndicatorSelection() {
            indicatorConfig = defaultIndicatorConfig;
            selectedIndicators = getDefaultIndicators();
            renderIndicatorSelection();
            updateIndicatorCount();
        }
        
        function getDefaultIndicators() {
            const defaults = {};
            Object.keys(indicatorConfig).forEach(category => {
                Object.keys(indicatorConfig[category]).forEach(indicator => {
                    if (indicatorConfig[category][indicator].required || indicatorConfig[category][indicator].default) {
                        defaults[indicator] = true;
                    }
                });
            });
            return defaults;
        }
        
        function renderIndicatorSelection() {
            const container = document.getElementById('indicatorCategories');
            if (!container) return;
            
            container.innerHTML = '';
            
            Object.keys(indicatorConfig).forEach(categoryName => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'indicator-category';
                
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'category-header';
                categoryHeader.innerHTML = `
                    <h4>${categoryName}</h4>
                    <div class="category-controls">
                        <button class="category-btn" onclick="selectCategoryAll('${categoryName}')">All</button>
                        <button class="category-btn" onclick="selectCategoryNone('${categoryName}')">None</button>
                    </div>
                `;
                categoryDiv.appendChild(categoryHeader);
                
                const indicatorsGrid = document.createElement('div');
                indicatorsGrid.className = 'indicators-grid';
                
                Object.keys(indicatorConfig[categoryName]).forEach(indicatorId => {
                    const config = indicatorConfig[categoryName][indicatorId];
                    const indicatorDiv = document.createElement('div');
                    indicatorDiv.className = 'indicator-item';
                    
                    const isSelected = selectedIndicators[indicatorId] || false;
                    const isRequired = config.required;
                    
                    indicatorDiv.innerHTML = `
                        <label class="indicator-checkbox ${isRequired ? 'required' : ''}">
                            <input type="checkbox" 
                                   id="indicator_${indicatorId}" 
                                   ${isSelected ? 'checked' : ''} 
                                   ${isRequired ? 'disabled' : ''}
                                   onchange="toggleIndicator('${indicatorId}')">
                            <span class="checkmark"></span>
                            <div class="indicator-info">
                                <div class="indicator-name">${config.name}</div>
                                <div class="indicator-description">${config.description}</div>
                                ${isRequired ? '<span class="required-badge">Required</span>' : ''}
                            </div>
                        </label>
                    `;
                    
                    indicatorsGrid.appendChild(indicatorDiv);
                });
                
                categoryDiv.appendChild(indicatorsGrid);
                container.appendChild(categoryDiv);
            });
        }
        
        function toggleIndicator(indicatorId) {
            const checkbox = document.getElementById(`indicator_${indicatorId}`);
            selectedIndicators[indicatorId] = checkbox.checked;
            updateIndicatorCount();
        }
        
        function selectCategoryAll(categoryName) {
            Object.keys(indicatorConfig[categoryName]).forEach(indicatorId => {
                selectedIndicators[indicatorId] = true;
                const checkbox = document.getElementById(`indicator_${indicatorId}`);
                if (checkbox) checkbox.checked = true;
            });
            updateIndicatorCount();
        }
        
        function selectCategoryNone(categoryName) {
            Object.keys(indicatorConfig[categoryName]).forEach(indicatorId => {
                if (!indicatorConfig[categoryName][indicatorId].required) {
                    selectedIndicators[indicatorId] = false;
                    const checkbox = document.getElementById(`indicator_${indicatorId}`);
                    if (checkbox) checkbox.checked = false;
                }
            });
            updateIndicatorCount();
        }
        
        function loadIndicatorPreset(presetName) {
            switch(presetName) {
                case 'minimal':
                    selectedIndicators = {};
                    Object.keys(indicatorConfig).forEach(category => {
                        Object.keys(indicatorConfig[category]).forEach(indicator => {
                            selectedIndicators[indicator] = indicatorConfig[category][indicator].required;
                        });
                    });
                    break;
                    
                case 'default':
                    selectedIndicators = getDefaultIndicators();
                    break;
                    
                case 'advanced':
                    selectedIndicators = {};
                    Object.keys(indicatorConfig).forEach(category => {
                        Object.keys(indicatorConfig[category]).forEach(indicator => {
                            selectedIndicators[indicator] = true;
                        });
                    });
                    // Exclude some very advanced ones
                    selectedIndicators['TRIX'] = false;
                    selectedIndicators['UO'] = false;
                    break;
                    
                case 'all':
                    selectedIndicators = {};
                    Object.keys(indicatorConfig).forEach(category => {
                        Object.keys(indicatorConfig[category]).forEach(indicator => {
                            selectedIndicators[indicator] = true;
                        });
                    });
                    break;
            }
            
            // Update checkboxes
            Object.keys(selectedIndicators).forEach(indicatorId => {
                const checkbox = document.getElementById(`indicator_${indicatorId}`);
                if (checkbox) checkbox.checked = selectedIndicators[indicatorId];
            });
            
            updateIndicatorCount();
        }
        
        function toggleIndicatorSelection() {
            const panel = document.getElementById('indicatorSelectionPanel');
            const icon = document.getElementById('indicatorToggleIcon');
            const text = document.getElementById('indicatorToggleText');
            
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                icon.textContent = '‚ñ≤';
                text.textContent = 'Hide Indicators';
            } else {
                panel.style.display = 'none';
                icon.textContent = '‚ñº';
                text.textContent = 'Customize Indicators';
            }
        }
        
        function updateIndicatorCount() {
            const count = Object.values(selectedIndicators).filter(Boolean).length;
            document.getElementById('selectedIndicatorCount').textContent = count;
        }
        
        // Load quick select tickers from backend
        function loadQuickSelectTickers() {
            console.log('Loading quick select tickers from backend...');
            
            fetch('/api/tickers')
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Failed to load tickers: ' + response.status);
                    }
                    return response.json();
                })
                .then(function(data) {
                    console.log('Tickers loaded:', data);
                    quickSelectTickers = data.tickers || [];
                    renderQuickSelectButtons();
                })
                .catch(function(error) {
                    console.error('Error loading tickers:', error);
                    // Fallback to default tickers if API fails
                    quickSelectTickers = ['AAPL', 'GOOGL', 'MSFT', 'TSLA', 'NVDA', 'AMZN', 'META', 'AMD', 'NFLX', 'SPY'];
                    renderQuickSelectButtons();
                    showError('Using default tickers. Backend connection issue: ' + error.message);
                });
        }
        
        // Render quick select buttons dynamically
        function renderQuickSelectButtons() {
            const container = document.getElementById('quickSelectRow');
            if (!container) {
                console.error('Quick select container not found');
                return;
            }
            
            container.innerHTML = ''; // Clear existing buttons
            
            quickSelectTickers.forEach(function(ticker) {
                const button = document.createElement('button');
                button.className = 'quick-symbol-compact';
                button.textContent = ticker;
                button.onclick = function() { quickAnalyze(ticker); };
                container.appendChild(button);
            });
            
            console.log('Rendered', quickSelectTickers.length, 'quick select buttons');
        }
        
        // Main analysis function
        function analyzeSymbol(symbol) {
            console.log('Analyzing symbol:', symbol);
            currentSymbol = symbol;
            
            showLoading();
            hideResults();
            hideError();
            
            // Prepare selected indicators for backend
            const indicatorsList = Object.keys(selectedIndicators).filter(key => selectedIndicators[key]);
            
            fetch('/analyze/' + symbol, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    indicators: indicatorsList
                })
            })
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                    }
                    return response.json();
                })
                .then(function(data) {
                    console.log('Analysis data received for', symbol);
                    if (data.error) {
                        showError(data.error);
                    } else {
                        displayResults(data);
                    }
                })
                .catch(function(error) {
                    console.error('Analysis error for', symbol, ':', error);
                    if (error.message.includes('404')) {
                        showError('Stock symbol "' + symbol + '" not found. Please check the symbol and try again.');
                    } else if (error.message.includes('500')) {
                        showError('Server error analyzing "' + symbol + '". Please try again later.');
                    } else {
                        showError('Error analyzing "' + symbol + '": ' + error.message);
                    }
                })
                .finally(function() {
                    hideLoading();
                });
        }
        
        // Input field functions
        function analyzeInputSymbol() {
            var input = document.getElementById('symbolInput');
            var symbol = input.value.trim().toUpperCase();
            
            if (!symbol) {
                showError('Please enter a stock symbol');
                return;
            }
            
            if (symbol.length > 10) {
                showError('Symbol too long. Please enter a valid stock symbol');
                return;
            }
            
            analyzeSymbol(symbol);
        }
        
        function quickAnalyze(symbol) {
            document.getElementById('symbolInput').value = symbol;
            analyzeSymbol(symbol);
            
            // Add visual feedback to the clicked button
            document.querySelectorAll('.quick-symbol-btn').forEach(function(btn) {
                btn.classList.remove('active');
            });
            event.target.closest('.quick-symbol-btn').classList.add('active');
        }
        
        // Display results function
        function displayResults(data) {
            var resultDiv = document.getElementById('analysisResult');
            var signalInfo = getSignalInfo(data);
            var scoreClass = getScoreClass(data.signal_score);
            
            var resultHTML = 
                '<div class="result-header">' +
                    '<div>' +
                        '<h2 class="symbol-title">' + data.symbol + '</h2>' +
                        '<p>Price: $' + data.current_price.toFixed(2) + ' | Date: ' + data.date + '</p>' +
                    '</div>' +
                    '<div style="display: flex; align-items: center;">' +
                        '<div class="score-circle ' + scoreClass + '">' +
                            data.signal_score + '/20' +
                        '</div>' +
                        '<div class="signal-badge ' + signalInfo.signalClass + '">' +
                            signalInfo.signalText +
                        '</div>' +
                    '</div>' +
                '</div>';
            
            // Add technical metrics
            if (data.technical_data) {
                resultHTML += '<div class="metrics-grid">' + generateMetricsHTML(data) + '</div>';
            }
            
            // Add score breakdown
            if (data.score_breakdown) {
                resultHTML += generateScoreBreakdownHTML(data);
            }
            
            // Add trading plan for BUY signals
            if (data.trading_plan && data.entry_signal) {
                resultHTML += generateTradingPlanHTML(data);
            }
            
            // Add entry recommendations for HOLD/WAIT signals
            if (!data.entry_signal && data.valuation_metrics) {
                resultHTML += generateEntryRecommendationsHTML(data);
            }
            
            // Add signals list
            if (data.signals && data.signals.length > 0) {
                resultHTML += generateSignalsHTML(data.signals);
            }
            
            resultDiv.innerHTML = resultHTML;
            resultDiv.style.display = 'block';
        }
        
        function generateMetricsHTML(data) {
            var tech = data.technical_data;
            var valuation = data.valuation_metrics;
            var scores = data.indicator_scores || {};
            
            return '<div class="metric-card">' +
                    '<div class="metric-label">RSI (14)</div>' +
                    '<div class="metric-value ' + getIndicatorClass('RSI', scores) + '">' + 
                        tech.RSI.toFixed(1) + 
                        '<span class="indicator-signal">' + getIndicatorSignal('RSI', scores) + '</span>' +
                    '</div>' +
                '</div>' +
                '<div class="metric-card">' +
                    '<div class="metric-label">MACD</div>' +
                    '<div class="metric-value ' + getIndicatorClass('MACD', scores) + '">' + 
                        tech.MACD.toFixed(3) + 
                        '<span class="indicator-signal">' + getIndicatorSignal('MACD', scores) + '</span>' +
                    '</div>' +
                '</div>' +
                '<div class="metric-card">' +
                    '<div class="metric-label">ADX</div>' +
                    '<div class="metric-value ' + getIndicatorClass('ADX', scores) + '">' + 
                        tech.ADX.toFixed(1) + 
                        '<span class="indicator-signal">' + getIndicatorSignal('ADX', scores) + '</span>' +
                    '</div>' +
                '</div>' +
                '<div class="metric-card">' +
                    '<div class="metric-label">Williams %R</div>' +
                    '<div class="metric-value ' + getIndicatorClass('Williams_R', scores) + '">' + 
                        tech.Williams_R.toFixed(1) + 
                        '<span class="indicator-signal">' + getIndicatorSignal('Williams_R', scores) + '</span>' +
                    '</div>' +
                '</div>' +
                '<div class="metric-card">' +
                    '<div class="metric-label">Money Flow Index</div>' +
                    '<div class="metric-value ' + getIndicatorClass('MFI', scores) + '">' + 
                        tech.MFI.toFixed(1) + 
                        '<span class="indicator-signal">' + getIndicatorSignal('MFI', scores) + '</span>' +
                    '</div>' +
                '</div>' +
                '<div class="metric-card">' +
                    '<div class="metric-label">vs SMA 200</div>' +
                    '<div class="metric-value ' + getIndicatorClass('SMA_200_Position', scores) + '">' + 
                        valuation.distance_from_sma200.toFixed(1) + '%' +
                        '<span class="indicator-signal">' + getIndicatorSignal('SMA_200_Position', scores) + '</span>' +
                    '</div>' +
                '</div>' +
                '<div class="metric-card">' +
                    '<div class="metric-label">52W Position</div>' +
                    '<div class="metric-value ' + getIndicatorClass('Position_52W', scores) + '">' + 
                        valuation.position_52w.toFixed(1) + '%' +
                        '<span class="indicator-signal">' + getIndicatorSignal('Position_52W', scores) + '</span>' +
                    '</div>' +
                '</div>' +
                '<div class="metric-card">' +
                    '<div class="metric-label">Volume Ratio</div>' +
                    '<div class="metric-value ' + getIndicatorClass('Volume_Ratio', scores) + '">' + 
                        tech.Volume_Ratio.toFixed(2) + 'x' +
                        '<span class="indicator-signal">' + getIndicatorSignal('Volume_Ratio', scores) + '</span>' +
                    '</div>' +
                '</div>';
        }
        
        function getIndicatorClass(indicator, scores) {
            if (!scores[indicator]) return 'indicator-neutral';
            
            switch(scores[indicator].score) {
                case 'bullish': return 'indicator-bullish';
                case 'bearish': return 'indicator-bearish';
                case 'neutral': return 'indicator-neutral';
                default: return 'indicator-neutral';
            }
        }
        
        function getIndicatorSignal(indicator, scores) {
            if (!scores[indicator]) return '';
            return scores[indicator].signal || '';
        }
        
        function generateScoreBreakdownHTML(data) {
            var breakdown = data.score_breakdown;
            var summary = data.recommendation_summary;
            
            var html = '<div class="score-breakdown">' +
                '<h4>üìä Score Breakdown (' + data.signal_score + '/20 points):</h4>' +
                '<div class="breakdown-grid">' +
                    '<div class="breakdown-item">' +
                        '<span class="breakdown-label">Base Signals:</span>' +
                        '<span class="breakdown-value">' + breakdown.base_score + '</span>' +
                    '</div>' +
                    '<div class="breakdown-item">' +
                        '<span class="breakdown-label">Trend:</span>' +
                        '<span class="breakdown-value">' + breakdown.trend_score + '</span>' +
                    '</div>' +
                    '<div class="breakdown-item">' +
                        '<span class="breakdown-label">Momentum:</span>' +
                        '<span class="breakdown-value">' + breakdown.momentum_score + '</span>' +
                    '</div>' +
                    '<div class="breakdown-item">' +
                        '<span class="breakdown-label">Volume:</span>' +
                        '<span class="breakdown-value">' + breakdown.volume_score + '</span>' +
                    '</div>' +
                    '<div class="breakdown-item">' +
                        '<span class="breakdown-label">Valuation:</span>' +
                        '<span class="breakdown-value">' + breakdown.valuation_penalty + '</span>' +
                    '</div>' +
                    '<div class="breakdown-item total">' +
                        '<span class="breakdown-label">Total:</span>' +
                        '<span class="breakdown-value">' + breakdown.total_score + '</span>' +
                    '</div>' +
                '</div>' +
            '</div>';
            
            // Add recommendation summary for non-BUY signals
            if (summary && summary.type !== 'BUY') {
                html += generateRecommendationSummaryHTML(summary);
            }
            
            return html;
        }
        
        function generateRecommendationSummaryHTML(summary) {
            var typeClass = summary.type.toLowerCase() + '-summary';
            var icon = summary.type === 'MONITOR' ? '‚ö†Ô∏è' : '‚ùå';
            
            var html = '<div class="recommendation-summary ' + typeClass + '">' +
                '<h4>' + icon + ' ' + summary.title + '</h4>' +
                '<p class="summary-text">' + summary.summary + '</p>';
            
            if (summary.key_points && summary.key_points.length > 0) {
                html += '<div class="key-issues">' +
                    '<h5>Key Issues:</h5>' +
                    '<ul>';
                summary.key_points.forEach(function(point) {
                    html += '<li>' + point + '</li>';
                });
                html += '</ul></div>';
            }
            
            if (summary.what_to_watch && summary.what_to_watch.length > 0) {
                html += '<div class="what-to-watch">' +
                    '<h5>What to Watch:</h5>' +
                    '<ul>';
                summary.what_to_watch.forEach(function(item) {
                    html += '<li>' + item + '</li>';
                });
                html += '</ul></div>';
            }
            
            html += '</div>';
            return html;
        }
        
        function generateTradingPlanHTML(data) {
            var plan = data.trading_plan;
            
            return '<div class="trading-plan-section">' +
                '<h3 class="plan-title">üìã Trading Plan (3-4 Month Hold)</h3>' +
                '<div class="plan-grid">' +
                    '<div class="plan-card entry-card">' +
                        '<h4>üéØ Entry Point</h4>' +
                        '<div class="plan-value">$' + data.current_price.toFixed(2) + '</div>' +
                        '<div class="plan-note">Current market price</div>' +
                    '</div>' +
                    '<div class="plan-card stop-card">' +
                        '<h4>üõë Stop Loss</h4>' +
                        '<div class="plan-value">$' + plan.stop_loss.recommended.toFixed(2) + '</div>' +
                        '<div class="plan-note">Risk: ' + plan.stop_loss.risk_percent.toFixed(1) + '%</div>' +
                    '</div>' +
                    '<div class="plan-card target-card">' +
                        '<h4>üöÄ Primary Target</h4>' +
                        '<div class="plan-value">$' + plan.exit_targets.Primary_Target.toFixed(2) + '</div>' +
                        '<div class="plan-note">27.5% gain target</div>' +
                    '</div>' +
                    '<div class="plan-card ratio-card">' +
                        '<h4>‚öñÔ∏è Risk/Reward</h4>' +
                        '<div class="plan-value">1:' + plan.risk_reward_ratio.toFixed(1) + '</div>' +
                        '<div class="plan-note">' + (plan.risk_reward_ratio >= 2 ? 'Good ratio' : 'Consider risk') + '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="profit-targets">' +
                    '<h4>üìà Partial Profit Targets:</h4>' +
                    '<div class="targets-grid">' +
                        '<div class="target-item">' +
                            '<span class="target-label">Target 1 (15%)</span>' +
                            '<span class="target-price">$' + plan.exit_targets.Target_1.toFixed(2) + '</span>' +
                            '<span class="target-action">Sell 1/3</span>' +
                        '</div>' +
                        '<div class="target-item">' +
                            '<span class="target-label">Target 2 (22%)</span>' +
                            '<span class="target-price">$' + plan.exit_targets.Target_2.toFixed(2) + '</span>' +
                            '<span class="target-action">Sell 1/3</span>' +
                        '</div>' +
                        '<div class="target-item">' +
                            '<span class="target-label">Target 3 (27.5%)</span>' +
                            '<span class="target-price">$' + plan.exit_targets.Target_3.toFixed(2) + '</span>' +
                            '<span class="target-action">Sell Final 1/3</span>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }
        
        function generateEntryRecommendationsHTML(data) {
            var currentPrice = data.current_price;
            var tech = data.technical_data;
            
            var entryLevels = [
                { level: '5% Pullback', price: currentPrice * 0.95, discount: 5 },
                { level: '10% Pullback', price: currentPrice * 0.90, discount: 10 },
                { level: 'EMA 50', price: tech.EMA_50, discount: ((currentPrice - tech.EMA_50) / currentPrice * 100) },
                { level: 'SMA 200', price: tech.SMA_200, discount: ((currentPrice - tech.SMA_200) / currentPrice * 100) }
            ].filter(function(entry) { return entry.price > 0 && entry.discount > 0; });
            
            var signalType = data.signal_score >= 5 ? 'hold-signal' : 'wait-signal';
            var signalMessage = data.signal_score >= 5 ? '‚ö†Ô∏è Hold/Monitor' : '‚ùå Wait for Better Setup';
            
            var html = '<div class="wait-recommendation ' + signalType + '">' +
                '<h4>' + signalMessage + '</h4>' +
                '<div class="suggested-entry-levels">' +
                    '<h5>üí° Consider Entry At These Levels:</h5>' +
                    '<div class="entry-levels-grid">';
            
            entryLevels.forEach(function(entry) {
                html += '<div class="entry-level-item">' +
                    '<div class="level-name">' + entry.level + '</div>' +
                    '<div class="level-price">$' + entry.price.toFixed(2) + '</div>' +
                    '<div class="level-discount">' + entry.discount.toFixed(1) + '% below current</div>' +
                '</div>';
            });
            
            html += '</div></div></div>';
            return html;
        }
        
        function generateSignalsHTML(signals) {
            var html = '<div class="signals-section">' +
                '<h3 class="signals-title">Bullish Signals Detected:</h3>' +
                '<div class="signals-list">';
            
            signals.forEach(function(signal) {
                html += '<span class="signal-tag">' + signal + '</span>';
            });
            
            html += '</div></div>';
            return html;
        }
        
        function getSignalInfo(data) {
            if (data.entry_signal) {
                return { signalClass: 'signal-buy', signalText: '‚úÖ BUY SIGNAL' };
            } else if (data.signal_score >= 5) {
                return { signalClass: 'signal-hold', signalText: '‚ö†Ô∏è HOLD/MONITOR' };
            } else {
                return { signalClass: 'signal-wait', signalText: '‚ùå WAIT' };
            }
        }
        
        function getScoreClass(score) {
            if (score >= 12) return 'score-high';
            if (score >= 8) return 'score-medium';
            if (score >= 5) return 'score-low';
            return 'score-very-low';
        }
        
        // Utility functions
        function showLoading() {
            var loadingDiv = document.getElementById('loadingMessage');
            if (loadingDiv) loadingDiv.style.display = 'block';
        }
        
        function hideLoading() {
            var loadingDiv = document.getElementById('loadingMessage');
            if (loadingDiv) loadingDiv.style.display = 'none';
        }
        
        function hideResults() {
            var resultDiv = document.getElementById('analysisResult');
            if (resultDiv) resultDiv.style.display = 'none';
        }
        
        function showError(message) {
            var errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }
        
        function hideError() {
            var errorDiv = document.getElementById('errorMessage');
            if (errorDiv) errorDiv.style.display = 'none';
        }
        
        // Enhanced JavaScript functions for color-coded indicators
        // Add these functions to your index.html script section

        // Enhanced metrics HTML generation with color coding
        function generateMetricsHTML(data) {
            var tech = data.technical_data;
            var valuation = data.valuation_metrics;
            var scores = data.indicator_scores || {};
            
            return `
                <div class="metric-card ${getIndicatorClass('RSI', scores)}">
                    <div class="metric-label">RSI (14)</div>
                    <div class="metric-value">
                        ${tech.RSI.toFixed(1)}
                        <span class="indicator-signal">${getIndicatorSignal('RSI', scores)}</span>
                    </div>
                </div>
                <div class="metric-card ${getIndicatorClass('MACD', scores)}">
                    <div class="metric-label">MACD</div>
                    <div class="metric-value">
                        ${tech.MACD.toFixed(3)}
                        <span class="indicator-signal">${getIndicatorSignal('MACD', scores)}</span>
                    </div>
                </div>
                <div class="metric-card ${getIndicatorClass('ADX', scores)}">
                    <div class="metric-label">ADX</div>
                    <div class="metric-value">
                        ${tech.ADX.toFixed(1)}
                        <span class="indicator-signal">${getIndicatorSignal('ADX', scores)}</span>
                    </div>
                </div>
                <div class="metric-card ${getIndicatorClass('Williams_R', scores)}">
                    <div class="metric-label">Williams %R</div>
                    <div class="metric-value">
                        ${tech.Williams_R.toFixed(1)}
                        <span class="indicator-signal">${getIndicatorSignal('Williams_R', scores)}</span>
                    </div>
                </div>
                <div class="metric-card ${getIndicatorClass('MFI', scores)}">
                    <div class="metric-label">Money Flow Index</div>
                    <div class="metric-value">
                        ${tech.MFI.toFixed(1)}
                        <span class="indicator-signal">${getIndicatorSignal('MFI', scores)}</span>
                    </div>
                </div>
                <div class="metric-card ${getIndicatorClass('BB_Position', scores)}">
                    <div class="metric-label">Bollinger Band Position</div>
                    <div class="metric-value">
                        ${tech.BB_Position.toFixed(1)}%
                        <span class="indicator-signal">${getIndicatorSignal('BB_Position', scores)}</span>
                    </div>
                </div>
                <div class="metric-card ${getIndicatorClass('SMA_200_Position', scores)}">
                    <div class="metric-label">vs SMA 200</div>
                    <div class="metric-value">
                        ${valuation.distance_from_sma200.toFixed(1)}%
                        <span class="indicator-signal">${getIndicatorSignal('SMA_200_Position', scores)}</span>
                    </div>
                </div>
                <div class="metric-card ${getIndicatorClass('Position_52W', scores)}">
                    <div class="metric-label">52W Position</div>
                    <div class="metric-value">
                        ${valuation.position_52w.toFixed(1)}%
                        <span class="indicator-signal">${getIndicatorSignal('Position_52W', scores)}</span>
                    </div>
                </div>
                <div class="metric-card ${getIndicatorClass('Volume_Ratio', scores)}">
                    <div class="metric-label">Volume Ratio</div>
                    <div class="metric-value">
                        ${tech.Volume_Ratio.toFixed(2)}x
                        <span class="indicator-signal">${getIndicatorSignal('Volume_Ratio', scores)}</span>
                    </div>
                </div>
                <div class="metric-card ${getIndicatorClass('Stochastic', scores)}">
                    <div class="metric-label">Stochastic</div>
                    <div class="metric-value">
                        ${getStochasticValue(scores)}
                        <span class="indicator-signal">${getIndicatorSignal('Stochastic', scores)}</span>
                    </div>
                </div>
                <div class="metric-card ${getIndicatorClass('CCI', scores)}">
                    <div class="metric-label">CCI</div>
                    <div class="metric-value">
                        ${tech.CCI.toFixed(1)}
                        <span class="indicator-signal">${getIndicatorSignal('CCI', scores)}</span>
                    </div>
                </div>
                <div class="metric-card ${getIndicatorClass('ROC', scores)}">
                    <div class="metric-label">Rate of Change</div>
                    <div class="metric-value">
                        ${tech.ROC.toFixed(1)}%
                        <span class="indicator-signal">${getIndicatorSignal('ROC', scores)}</span>
                    </div>
                </div>
            `;
        }

        // Enhanced indicator class function
        function getIndicatorClass(indicator, scores) {
            if (!scores[indicator]) return 'indicator-neutral';
            
            switch(scores[indicator].score) {
                case 'bullish': return 'indicator-bullish';
                case 'bearish': return 'indicator-bearish';
                case 'neutral': return 'indicator-neutral';
                default: return 'indicator-neutral';
            }
        }

        // Enhanced indicator signal function
        function getIndicatorSignal(indicator, scores) {
            if (!scores[indicator]) return 'No Signal';
            return scores[indicator].signal || 'No Signal';
        }

        // Helper function for stochastic value display
        function getStochasticValue(scores) {
            if (scores['Stochastic'] && scores['Stochastic'].value) {
                return scores['Stochastic'].value;
            }
            return 'N/A';
        }

        // Enhanced display results function with improved indicator visualization
        function displayResults(data) {
            var resultDiv = document.getElementById('analysisResult');
            var signalInfo = getSignalInfo(data);
            var scoreClass = getScoreClass(data.signal_score);
            
            // Enhanced header with indicator summary
            var resultHTML = `
                <div class="result-header">
                    <div>
                        <h2 class="symbol-title">${data.symbol}</h2>
                        <p>Price: $${data.current_price.toFixed(2)} | Date: ${data.date}</p>
                        ${generateIndicatorSummary(data.indicator_scores)}
                    </div>
                    <div style="display: flex; align-items: center;">
                        <div class="score-circle ${scoreClass}">
                            ${data.signal_score}/20
                        </div>
                        <div class="signal-badge ${signalInfo.signalClass}">
                            ${signalInfo.signalText}
                        </div>
                    </div>
                </div>
            `;
            
            // Add technical metrics with color coding
            if (data.technical_data) {
                resultHTML += `<div class="metrics-grid">${generateMetricsHTML(data)}</div>`;
            }
            
            // Add indicator breakdown section
            if (data.indicator_scores) {
                resultHTML += generateIndicatorBreakdownHTML(data.indicator_scores);
            }
            
            // Add score breakdown
            if (data.score_breakdown) {
                resultHTML += generateScoreBreakdownHTML(data);
            }
            
            // Add trading plan for BUY signals
            if (data.trading_plan && data.entry_signal) {
                resultHTML += generateTradingPlanHTML(data);
            }
            
            // Add entry recommendations for HOLD/WAIT signals
            if (!data.entry_signal && data.valuation_metrics) {
                resultHTML += generateEntryRecommendationsHTML(data);
            }
            
            // Add signals list
            if (data.signals && data.signals.length > 0) {
                resultHTML += generateSignalsHTML(data.signals);
            }
            
            resultDiv.innerHTML = resultHTML;
            resultDiv.style.display = 'block';
            
            // Add animation for indicator cards
            setTimeout(function() {
                animateIndicatorCards();
            }, 100);
        }

        // Generate indicator summary
        function generateIndicatorSummary(scores) {
            if (!scores) return '';
            
            var bullishCount = 0;
            var bearishCount = 0;
            var neutralCount = 0;
            
            Object.values(scores).forEach(function(score) {
                switch(score.score) {
                    case 'bullish': bullishCount++; break;
                    case 'bearish': bearishCount++; break;
                    case 'neutral': neutralCount++; break;
                }
            });
            
            return `
                <div class="indicator-summary">
                    <span class="summary-item bullish">üü¢ ${bullishCount} Bullish</span>
                    <span class="summary-item neutral">üü° ${neutralCount} Neutral</span>
                    <span class="summary-item bearish">üî¥ ${bearishCount} Bearish</span>
                </div>
            `;
        }

        // Generate detailed indicator breakdown
        function generateIndicatorBreakdownHTML(scores) {
            var html = `
                <div class="indicator-breakdown">
                    <h4>üìä Indicator Analysis Summary:</h4>
                    <div class="breakdown-categories">
            `;
            
            // Group indicators by status
            var bullishIndicators = [];
            var bearishIndicators = [];
            var neutralIndicators = [];
            
            Object.entries(scores).forEach(function([key, value]) {
                var displayName = getIndicatorDisplayName(key);
                var item = { name: displayName, signal: value.signal, value: value.value };
                
                switch(value.score) {
                    case 'bullish': bullishIndicators.push(item); break;
                    case 'bearish': bearishIndicators.push(item); break;
                    case 'neutral': neutralIndicators.push(item); break;
                }
            });
            
            // Generate breakdown sections
            if (bullishIndicators.length > 0) {
                html += generateIndicatorCategoryHTML('Bullish Signals', bullishIndicators, 'bullish');
            }
            
            if (neutralIndicators.length > 0) {
                html += generateIndicatorCategoryHTML('Neutral Signals', neutralIndicators, 'neutral');
            }
            
            if (bearishIndicators.length > 0) {
                html += generateIndicatorCategoryHTML('Bearish Signals', bearishIndicators, 'bearish');
            }
            
            html += '</div></div>';
            return html;
        }

        // Generate indicator category HTML
        function generateIndicatorCategoryHTML(title, indicators, type) {
            var icon = type === 'bullish' ? 'üü¢' : type === 'bearish' ? 'üî¥' : 'üü°';
            var className = `breakdown-category ${type}`;
            
            var html = `
                <div class="${className}">
                    <h5>${icon} ${title} (${indicators.length})</h5>
                    <div class="category-indicators">
            `;
            
            indicators.forEach(function(indicator) {
                html += `
                    <div class="indicator-detail">
                        <span class="indicator-name">${indicator.name}</span>
                        <span class="indicator-signal">${indicator.signal}</span>
                    </div>
                `;
            });
            
            html += '</div></div>';
            return html;
        }

        // Get display name for indicators
        function getIndicatorDisplayName(key) {
            var names = {
                'RSI': 'RSI (14)',
                'MACD': 'MACD',
                'ADX': 'ADX',
                'Williams_R': 'Williams %R',
                'MFI': 'Money Flow Index',
                'BB_Position': 'Bollinger Bands',
                'SMA_200_Position': 'SMA 200',
                'Position_52W': '52-Week Position',
                'Volume_Ratio': 'Volume',
                'Stochastic': 'Stochastic',
                'CCI': 'CCI',
                'ROC': 'Rate of Change'
            };
            
            return names[key] || key;
        }

        // Animate indicator cards on load
        function animateIndicatorCards() {
            var cards = document.querySelectorAll('.metric-card');
            cards.forEach(function(card, index) {
                setTimeout(function() {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(20px)';
                    
                    setTimeout(function() {
                        card.style.transition = 'all 0.5s ease';
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, 50);
                }, index * 100);
            });
        }        

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initializing...');
            
            // Load quick select tickers from backend
            loadQuickSelectTickers();
            
            // Initialize indicator selection
            initializeIndicatorSelection();
            
            // Setup input field
            var input = document.getElementById('symbolInput');
            if (input) {
                input.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        analyzeInputSymbol();
                    }
                });
                
                input.addEventListener('focus', function() {
                    input.select();
                });
            }
            
            console.log('Dashboard ready');
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.key === 'r' || event.key === 'R') {
                if (currentSymbol) {
                    analyzeSymbol(currentSymbol);
                }
                event.preventDefault();
            }
            
            if (event.key === 'Escape') {
                hideResults();
                hideError();
                var input = document.getElementById('symbolInput');
                if (input) input.focus();
            }
        });
    </script>
</body>
</html>